<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>tarminal-signaling-server - adi-family docs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a24', 600: '#22222e' },
            accent: { 500: '#8b5cf6', 400: '#a78bfa', 300: '#c4b5fd' }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-toml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-docker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-nginx.min.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', system-ui, sans-serif; }
    code, pre { font-family: 'JetBrains Mono', monospace; }
    .glass { background: rgba(26, 26, 36, 0.7); backdrop-filter: blur(12px); }
    .gradient-border { position: relative; }
    .gradient-border::before {
      content: ''; position: absolute; inset: 0; border-radius: inherit; padding: 1px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(139, 92, 246, 0.1));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #22222e; border-radius: 4px; }

    /* Markdown content styles */
    .prose { }
    .prose h1 { font-size: 2rem; font-weight: 700; color: white; margin-bottom: 1rem; margin-top: 2rem; }
    .prose h2 { font-size: 1.5rem; font-weight: 600; color: white; margin-bottom: 0.75rem; margin-top: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.25rem; font-weight: 600; color: white; margin-bottom: 0.5rem; margin-top: 1.25rem; }
    .prose h4 { font-size: 1rem; font-weight: 600; color: white; margin-bottom: 0.5rem; margin-top: 1rem; }
    .prose p { color: #9ca3af; margin-bottom: 1rem; line-height: 1.7; }
    .prose ul, .prose ol { color: #9ca3af; margin-bottom: 1rem; padding-left: 1.5rem; }
    .prose li { margin-bottom: 0.5rem; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    .prose code:not(pre code) { background: #1a1a24; padding: 0.2rem 0.4rem; border-radius: 0.25rem; color: #a78bfa; font-size: 0.875rem; }
    .prose pre { background: #1a1a24 !important; border: 1px solid rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 1rem; overflow-x: auto; margin-bottom: 1rem; }
    .prose pre code { background: transparent !important; padding: 0; font-size: 0.875rem; }
    .prose pre[class*="language-"] { background: #1a1a24 !important; }
    code[class*="language-"], pre[class*="language-"] { text-shadow: none !important; }
    .prose a { color: #a78bfa; text-decoration: underline; }
    .prose a:hover { color: #c4b5fd; }
    .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    .prose th { text-align: left; padding: 0.75rem; background: #1a1a24; color: white; font-weight: 500; border: 1px solid rgba(255,255,255,0.05); }
    .prose td { padding: 0.75rem; color: #9ca3af; border: 1px solid rgba(255,255,255,0.05); }
    .prose blockquote { border-left: 4px solid #8b5cf6; padding-left: 1rem; margin-left: 0; color: #9ca3af; font-style: italic; }
    .prose hr { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 2rem 0; }
    .prose strong { color: white; }
  </style>
</head>
<body class="bg-dark-900 text-gray-300 antialiased">
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-accent-500/20 rounded-full blur-[100px]"></div>
    <div class="absolute top-1/2 -left-40 w-80 h-80 bg-accent-500/10 rounded-full blur-[100px]"></div>
  </div>

  <div class="relative min-h-screen">
    <header class="sticky top-0 z-30 glass border-b border-white/5">
      <div class="max-w-4xl mx-auto px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="../index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            <span>Back to docs</span>
          </a>
        </div>
        <span class="px-2 py-1 text-xs font-medium text-accent-400 bg-accent-500/10 rounded-full">Library</span>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-8 py-12">
      <div class="prose">
<h1>Tarminal Signaling Server</h1>

<p>WebSocket relay server for device pairing, sync, and cocoon (containerized worker) access control.</p>

<h2>Features</h2>

<ul>
<li><strong>Device Pairing</strong> - Pair devices using 6-character codes for sync</li>
<li><strong>Sync Relay</strong> - Forward sync messages between paired devices</li>
<li><strong>Secure Device IDs</strong> - HMAC-derived device IDs from client secrets (persistent sessions)</li>
<li><strong>Token-Based Access Control</strong> - Manage cocoon ownership with access tokens</li>
<li><strong>Multiple Ownership</strong> - Multiple users can claim ownership of same cocoon</li>
</ul>

<h2>Deploy</h2>

<h3>Docker (Recommended)</h3>

<pre><code class="language-bash">docker build -t tarminal-signaling .
docker run -p 8080:8080 \
  -e HMAC_SALT="your-random-salt-here" \
  tarminal-signaling
</code></pre>

<h3>Environment Variables</h3>

<ul>
<li><code>PORT</code> - Server port (default: 8080)</li>
<li><code>HMAC_SALT</code> - Salt for device ID derivation (keep secret, persist across restarts)</li>
</ul>

<h2>Protocol</h2>

<p>The server uses JSON over WebSocket. All messages have a <code>type</code> field.</p>

<h3>Device Registration</h3>

<pre><code class="language-json">{
  "type": "register",
  "secret": "your-strong-secret-min-32-chars",
  "device_id": null  // omit or null for first registration
}

// On reconnect:
{
  "type": "register",
  "secret": "same-secret-as-before",
  "device_id": "previously-assigned-id"
}

// Server response:
{
  "type": "registered",
  "device_id": "deterministic-id-from-hmac"
}
</code></pre>

<p><strong>Security</strong>: Server derives <code>device_id = HMAC-SHA256(secret, salt)</code>. Same secret always produces same device ID. On reconnect, server verifies provided device_id matches derived ID to prevent secret theft attacks.</p>

<h3>Device Pairing (For Sync)</h3>

<pre><code class="language-json">// Create pairing code
{ "type": "create_pairing_code" }

// Server response:
{ "type": "pairing_code", "code": "ABC123" }

// Use pairing code (on other device)
{ "type": "use_pairing_code", "code": "ABC123" }

// Server response (both devices):
{ "type": "paired", "peer_id": "other-device-id" }
</code></pre>

<h3>Sync Data</h3>

<pre><code class="language-json">{
  "type": "sync_data",
  "payload": { /* any JSON data */ }
}
</code></pre>

<p>Server forwards payload to paired device as-is.</p>

<h3>Cocoon Ownership (Token-Based Access Control)</h3>

<p>Cocoons are containerized workers. Users authenticate with access tokens to claim ownership and connect.</p>

<h4>Claim Ownership</h4>

<pre><code class="language-json">{
  "type": "claim_cocoon",
  "device_id": "cocoon-device-id",
  "secret": "cocoon-secret",
  "access_token": "user-jwt-or-token"
}

// Server response:
{ "type": "claim_successful", "device_id": "cocoon-device-id" }

// Or error:
{ "type": "error", "message": "Secret does not match device_id" }
</code></pre>

<p><strong>Multiple Ownership</strong>: Any number of users can claim the same cocoon by proving secret knowledge. All owners have equal rights.</p>

<h4>Connect to Cocoon</h4>

<pre><code class="language-json">{
  "type": "connect_to_cocoon",
  "device_id": "cocoon-device-id",
  "access_token": "user-jwt-or-token"
}

// Server response (if owner):
{ "type": "connected", "device_id": "cocoon-device-id" }

// Or access denied:
{ "type": "access_denied", "reason": "Only owners can connect" }
</code></pre>

<p>After connection, <code>sync_data</code> messages are relayed between user and cocoon.</p>

<h4>List My Cocoons</h4>

<pre><code class="language-json">{
  "type": "list_my_cocoons",
  "access_token": "user-jwt-or-token"
}

// Server response:
{
  "type": "my_cocoons",
  "cocoons": [
    {
      "device_id": "cocoon-1",
      "status": "online",
      "claimed_at": "2025-12-25T10:30:00Z"
    },
    {
      "device_id": "cocoon-2",
      "status": "offline",
      "claimed_at": "2025-12-20T15:45:00Z"
    }
  ]
}
</code></pre>

<h2>Security Model</h2>

<h3>Device Authentication</h3>

<ul>
<li><strong>Secret Storage</strong>: Clients store strong secrets (min 32 chars)</li>
<li><strong>Deterministic IDs</strong>: Server derives device ID using HMAC-SHA256</li>
<li><strong>Verification</strong>: On reconnect, client sends both secret and device_id for verification</li>
<li><strong>Anti-Theft</strong>: Stolen secret cannot register new device with same ID</li>
</ul>

<h3>User Authentication</h3>

<ul>
<li><strong>Access Tokens</strong>: JWT or OAuth tokens identify users</li>
<li><strong>Simple Extraction</strong>: Currently treats token as user_id (production should validate JWT)</li>
<li><strong>Future</strong>: Full JWT validation with signature verification</li>
</ul>

<h3>Ownership Model</h3>

<ul>
<li><strong>Claim with Secret</strong>: User proves cocoon ownership by providing secret + token</li>
<li><strong>Co-Ownership</strong>: Multiple users can claim same cocoon (shared secret)</li>
<li><strong>Equal Rights</strong>: All owners have identical permissions (no role hierarchy)</li>
<li><strong>Persistent</strong>: Ownership tracked in server memory (currently, add DB for persistence)</li>
</ul>

<h2>See Also</h2>

<ul>
<li><a href="./lib-tarminal-sync.html">lib-tarminal-sync</a> - Protocol definitions and sync messages</li>
<li>Cocoon - Containerized worker that connects to signaling server</li>
</ul>
      </div>
    </main>

    <footer class="max-w-4xl mx-auto px-8 py-8 border-t border-white/5">
      <div class="flex items-center justify-between text-sm text-gray-500">
        <a href="../index.html" class="hover:text-gray-300 transition-colors">Back to documentation</a>
        <span>adi-family</span>
      </div>
    </footer>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
      }
    });
  </script>
</body>
</html>
